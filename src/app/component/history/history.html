<div class="history-container">
  <div class="content-wrapper">
    <!-- Navigation Menu -->
    <div class="navigation-menu">
      <button mat-raised-button color="primary" routerLink="/location" class="nav-button">
        <mat-icon>location_on</mat-icon>
        Find Location
      </button>
      <button mat-raised-button routerLink="/history" class="nav-button">
        <mat-icon>history</mat-icon>
        History
      </button>
    </div>

    <!-- Form Section -->
    <div class="form-section">
      <div class="form-card">
        <div class="form-header">
          <h2 class="form-title">Phone Location History</h2>
        </div>

        <div class="selection-form">


          <div class="form-group">
            <label class="field-label">Select Phone Number</label>
            <mat-form-field class="phone-select">
              <mat-select (selectionChange)="onSelectionChange($event)" placeholder="Choose a phone number">
                @for (phoneNumber of phoneNumbers; track phoneNumber) {
                  <mat-option [value]="phoneNumber">{{ phoneNumber }}</mat-option>
                }
                @empty {
                  <mat-option disabled>No phone numbers available</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          @if (phoneLocations.length > 1) {
            <div class="form-actions">
              <button mat-raised-button color="accent" (click)="resetMapView()"
                      matTooltip="Show all markers on map" class="center-button">
                <mat-icon>center_focus_strong</mat-icon>
                Center Map
              </button>
            </div>
          }

          @if (loading()) {
            <div class="loading-section">
              <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
              <span class="loading-text">Loading phone locations...</span>
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Map Section -->
    @if (phoneLocations.length > 0) {
      <div class="map-section">
        <div class="map-card">
          <div class="map-header">
            <h3 class="map-title">Location History</h3>
            <div class="location-count">
              <span class="count-label">Locations found:</span>
              <span class="count-value">{{ phoneLocations.length }}</span>
            </div>
          </div>

          <div class="map-container">
            <google-map
              height="500px"
              width="100%"
              [options]="options"
              class="location-map">
              @for(marker of phoneLocations; track marker; let i = $index){
                <map-advanced-marker #markElem="mapAdvancedMarker"
                [position]="{lat: marker.latitude, lng: marker.longitude}"
                (mapClick)="showAddress(marker, markElem)"
                ></map-advanced-marker>
              } @empty{
                <map-advanced-marker #markElem="mapAdvancedMarker" [position]="{lat: 0, lng: 0}"></map-advanced-marker>
              }

              <!-- Single info window outside the loop -->
              <map-info-window
                #infoWindow="mapInfoWindow"
                (closeclick)="infoWindowVisible = false">
                <div class="info-window-content">
                  <h4 class="info-title">{{selectedMarkerData?.address || 'Location'}}</h4>
                  <div class="info-details">
                    <p><strong>Phone:</strong> {{selectedMarkerData?.phoneNumber}}</p>
                    <p><strong>Latitude:</strong> {{selectedMarkerData?.latitude | number:'1.6-6'}}</p>
                    <p><strong>Longitude:</strong> {{selectedMarkerData?.longitude | number:'1.6-6'}}</p>
                    @if (selectedMarkerData?.locationDateTime) {
                      <p><strong>Date:</strong> {{selectedMarkerData?.locationDateTime | date:'medium'}}</p>
                    }
                  </div>
                </div>
              </map-info-window>
            </google-map>
          </div>
        </div>
      </div>
    }
  </div>
</div>
