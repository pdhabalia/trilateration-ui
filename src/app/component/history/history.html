<div class="history-container">
  <div class="content-wrapper">

    <!-- Form Section -->
    <div class="form-section">
      <div class="form-card">
        <div class="form-header">
          <h2 class="form-title">Phone Location History</h2>
        </div>

        <div class="selection-form">


          <div class="form-group">
            <label class="field-label">Select Phone Number</label>
            <mat-form-field class="phone-select">
              <mat-select (selectionChange)="onSelectionChange($event)" placeholder="Choose a phone number">
                @for (phoneNumber of phoneNumbers; track phoneNumber) {
                  <mat-option [value]="phoneNumber">{{ phoneNumber }}</mat-option>
                }
                @empty {
                  <mat-option disabled>No phone numbers available</mat-option>
                }
              </mat-select>
            </mat-form-field>
          </div>

          @if (phoneLocations.length > 1) {
            <div class="form-actions">
              <button mat-raised-button color="accent" (click)="resetMapView()"
                      matTooltip="Show all markers on map" class="center-button">
                <mat-icon>center_focus_strong</mat-icon>
                Center Map
              </button>
            </div>
          }

          @if (loading()) {
            <div class="loading-section">
              <mat-progress-spinner mode="indeterminate" diameter="40"></mat-progress-spinner>
              <span class="loading-text">Loading phone locations...</span>
            </div>
          }
        </div>
      </div>
    </div>

    <!-- Map Section -->
    @if (phoneLocations.length > 0) {
      <div class="map-section">
        <div class="map-card">
          <div class="map-header">
            <div class="map-title-section">
              <h3 class="map-title">Location History</h3>
              <div class="location-count">
                <span class="count-label">Locations found:</span>
                <span class="count-value">{{ phoneLocations.length }}</span>
              </div>
            </div>
            <div class="map-actions">
              <button mat-icon-button
                      (click)="resetMapView()"
                      matTooltip="Reset map view to show all locations"
                      class="reset-view-btn">
                <mat-icon>center_focus_strong</mat-icon>
              </button>
            </div>
          </div>

          <div class="map-container">
            <!-- Loading overlay -->
            @if (loading()) {
              <div class="map-loading-state">
                <mat-spinner diameter="40"></mat-spinner>
                <h3>Loading Location Data...</h3>
                <p>Please wait while we fetch the location history</p>
              </div>
            }

            <!-- Empty state overlay -->
            @if (phoneLocations.length === 0 && !loading()) {
              <div class="map-empty-state">
                <mat-icon class="empty-icon">location_off</mat-icon>
                <h3>No Location Data</h3>
                <p>Select a phone number above to view location history on the map</p>
              </div>
            }

            <google-map
              [options]="options"
              [height]="'100%'"
              [width]="'100%'"
              class="location-map">
              @for(marker of phoneLocations; track marker; let i = $index){
                <map-advanced-marker #markElem="mapAdvancedMarker"
                [position]="{lat: marker.latitude, lng: marker.longitude}"
                (mapClick)="showAddress(marker, markElem)"
                ></map-advanced-marker>
              }

              <!-- Single info window outside the loop -->
              <map-info-window
                #infoWindow="mapInfoWindow"
                (closeclick)="infoWindowVisible = false">
                <div class="info-window-content">
                  <h4 class="info-title">{{selectedMarkerData?.address || 'Location'}}</h4>
                  <div class="info-details">
                    <p><strong>Phone:</strong> {{selectedMarkerData?.phoneNumber}}</p>
                    <p><strong>Latitude:</strong> {{selectedMarkerData?.latitude | number:'1.6-6'}}</p>
                    <p><strong>Longitude:</strong> {{selectedMarkerData?.longitude | number:'1.6-6'}}</p>
                    @if (selectedMarkerData?.locationDateTime) {
                      <p><strong>Date:</strong> {{selectedMarkerData?.locationDateTime | date:'medium'}}</p>
                    }
                  </div>
                </div>
              </map-info-window>
            </google-map>
          </div>
        </div>
      </div>
    }
  </div>
</div>
